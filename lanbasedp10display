#include <Ethernet.h>
#include <WebServer.h>
#include <EEPROM.h>
#include <ArduinoJson.h>

byte mac[] = { 0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0xED };
IPAddress ip(192, 168, 1, 177);
WebServer server(80);
IPAddress userIp;

void setup() {
  Serial.begin(115200);
  Ethernet.begin(mac, ip, gateway, gateway, subnet);

  if (Ethernet.hardwareStatus() == EthernetNoHardware) {
    Serial.println("Ethernet shield was not found. Sorry, can't run without hardware.");
    while (true) {
      delay(1);
    }
  }

  if (Ethernet.linkStatus() == LinkOFF) {
    Serial.println("Ethernet cable is not connected.");
  }
  Serial.print("Ethernet IP Address: ");
  Serial.println(Ethernet.localIP());
  server.on("/", handleRoot);
  server.on("/setIP", HTTP_POST, handleSetIP);
  server.on("/sendData", HTTP_POST, handleSendDataToDisplay);
  server.begin();
}

void loop() {
  server.handleClient();
}

void handleRoot() {
  String page = "<h1>Ethernet Configuration</h1>";
  page += "<h2>Change Static IP Settings</h2>";
  page += "<form method='POST' action='/setIP'>";
  page += "IP Address: <input type='text' name='ip' value='" + ip.toString() + "'><br>";
  page += "<button type='submit'>Save IP Settings</button>";
  page += "</form>";
  server.send(200, "text/html", page);
}

void handleSetIP() {
  if (server.hasArg("ip") && server.hasArg("gateway") && server.hasArg("subnet")) {
    String ipStr = server.arg("ip");
    userIp.fromString(ipStr);
    EEPROM.put(64, userIp);
    EEPROM.commit();
    server.send(200, "application/json", "{\"message\":\"IP settings saved! Rebooting...\"}");
    delay(2000);
    asm volatile ("  jmp 0");
  } 
  else {
    server.send(400, "application/json", "{\"error\":\"Missing 'ip', 'gateway', or 'subnet' in the form\"}");
  }
}

void handleSendDataToDisplay() {
  if (server.hasArg("plain")) {
    String jsonData = server.arg("plain");

    DynamicJsonDocument doc(1024);
    DeserializationError error = deserializeJson(doc, jsonData);
    if (error) {
      server.send(400, "text/plain", "Invalid JSON format");
      return;
    }

    if (doc.containsKey("value")) {
      String data = doc["value"].as<String>();
      Serial.println("Data to display: " + data);
      sendDataToDisplay(data);
      server.send(200, "text/plain", "Data sent to display: " + data);
    } else {
      server.send(400, "text/plain", "Bad Request - Missing 'value' field in JSON");
    }
  } else {
    server.send(400, "text/plain", "Bad Request - Missing body or invalid format");
  }
}

void sendDataToDisplay(String data) {
  void sendDataToDisplay(String data) {
  String dataToSendClear = "|C|2|6|";
  Serial2.print(dataToSendClear);
  Serial.println("Sent to display: " + dataToSendClear);
  delay(1000);

  String dataToSend = "|C|2|4|1|36-0-#B" + data + "|";
  Serial2.print(dataToSend);
  Serial.println("Sent to display: " + dataToSend);
}
}
